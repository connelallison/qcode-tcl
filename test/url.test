package require tcltest
eval ::tcltest::configure $argv
# Ensure package is loaded from ./qcode rather than /usr/lib/tcltk
set auto_path [linsert $auto_path 0 ./qcode]
package require qcode
namespace import qc::*

namespace eval ::qcode::test {

    namespace import ::tcltest::*

    # url_path
    test url_path-1.0 {url_path } -setup {
    } -body {
        url_path "/someplace.html?order_number=911&title=casáu"
    } -cleanup {} -result {/someplace.html}

    test url_path-1.1 {url_path full url} -setup {
    } -body {
        url_path "http://www.domain-name99.co.uk/someplace.html?order_number=911&title=casáu"
    } -cleanup {} -result {/someplace.html}

    test url_path-1.2 {url_path full url port number} -setup {
    } -body {		
        url_path "https://www.domain-name99.co.uk:8443/someplace.html?order_number=911&title=casáu"
    } -cleanup {} -result {/someplace.html}

    # url_encode
    test url_encode-1.0 {url_encode utf-8 safe characters} -body {
        url_encode {.-_~abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789}
    } -cleanup {} -result {.-_~abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789}

    test url_encode-1.1 {url_encode utf-8 some unsafe characters} -body {
        url_encode {!\"£$%^&*():? #'@[]{},/|+á
}
    } -cleanup {} -result {%21%5c%22%c2%a3%24%25%5e%26%2a%28%29%3a%3f+%23%27%40%5b%5d%7b%7d%2c%2f%7c%2b%c3%a1%0a}

    test url_encode-1.2 {url_encode iso8859-1 safe characters} -body {
        url_encode {.-_~abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789} iso8859-1
    } -cleanup {} -result {.-_~abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789}

    test url_encode-1.3 {url_encode iso8859-1 some unsafe characters} -body {
        url_encode {!\"£$%^&*():? #'@[]{},/|+á
} iso8859-1
    } -cleanup {} -result {%21%5c%22%a3%24%25%5e%26%2a%28%29%3a%3f+%23%27%40%5b%5d%7b%7d%2c%2f%7c%2b%e1%0a}

    # url_decode
    test url_decode-1.0 {url_decode utf-8 safe characters} -body {
        url_decode {.-_~abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789}
    } -cleanup {} -result {.-_~abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789}

    test url_decode-1.1 {url_decode utf-8 some unsafe characters} -body {
        url_decode {%21%5c%22%c2%a3%24%25%5e%26%2a%28%29%3a%3f+%23%27%40%5b%5d%7b%7d%2c%2f%7c%2b%c3%a1%0a}
    } -cleanup {} -result {!\"£$%^&*():? #'@[]{},/|+á
}

    test url_decode-1.2 {url_decode iso8859-1 safe characters} -body {
        url_decode {.-_~abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789} iso8859-1
    } -cleanup {} -result {.-_~abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789}

    test url_decode-1.3 {url_decode iso8859-1 some unsafe characters} -body {
        url_decode {%21%5c%22%a3%24%25%5e%26%2a%28%29%3a%3f+%23%27%40%5b%5d%7b%7d%2c%2f%7c%2b%e1%0a} iso8859-1
    } -cleanup {} -result {!\"£$%^&*():? #'@[]{},/|+á
}   

    # url 
    test url-1.0 {url some safe characters} -body {
        url someplace.html session_id 23.121 title Mr first_name Test last_name Test age ~25 dob 1988-03-13
    } -cleanup {} -result {someplace.html?last_name=Test&first_name=Test&session_id=23.121&dob=1988-03-13&age=~25&title=Mr}
    
    test url-1.0 {url some unsafe characters} -body {
        url someplace.html next_url someplace_else.html?name=Mr+Test+Test&email=test@test.com
    } -cleanup {} -result {someplace.html?next_url=someplace_else.html%3fname%3dMr%2bTest%2bTest%26email%3dtest%40test.com}
    
    cleanupTests
}
namespace delete ::qcode::test
